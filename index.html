<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å•è¯è®°å¿†ç³»ç»Ÿ</title>
<style>
  body { background:#f3f7fa; font-family: "Segoe UI", Tahoma, Arial; color:#222; margin:0; padding:18px; }
  .wrap{max-width:980px;margin:18px auto;background:#fff;border-radius:10px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{text-align:center;margin:6px 0 14px}
  .tabs{display:flex;gap:10px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:#eef6ff;color:#007bff;user-select:none}
  .tab.active{background:#007bff;color:#fff}
  #wordBox{min-height:140px;padding:14px;border-radius:8px;background:#fafafa;border:1px solid #eee;margin-bottom:12px}
  .wordItem{padding:10px;border-bottom:1px dashed #eee}
  .controls{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .btn{background:#007bff;color:#fff;padding:8px 14px;border:none;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#6c757d}
  .muted{color:#888;font-size:13px}
  .small{font-size:13px;color:#666}
  .stat{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:10px 0}
  .stat>div{background:#f6fbff;padding:10px;border-radius:8px;border:1px solid #e6f0ff;min-width:120px;text-align:center}
  .testArea{padding:12px;background:#fff;border-radius:8px;border:1px solid #eee;margin-top:12px}
  .choice{display:block;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #eee;cursor:pointer;background:#fff;user-select:none}
  .choice.correct{background:#e6ffea;border-color:#8fdd9c}
  .choice.wrong{background:#ffecec;border-color:#ff9a9a}
  .progressBar{height:10px;background:#e9f4ff;border-radius:999px;overflow:hidden;margin:12px 0}
  .progressBarInner{height:100%;background:#007bff;width:0%}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .center{display:flex;justify-content:center;align-items:center;gap:8px}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;background:#eee;font-size:12px}
  input[type="file"]{display:inline-block}
  .danger{background:#ff6b6b}
  .ok{background:#60c66d}
  .note{background:#fff8dc;padding:10px;border-radius:6px;border:1px solid #ffe6a7}
  .flex-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted-2{color:#9aa0a6;font-size:12px}

  /* å‘éŸ³æŒ‰é’®æ ·å¼ */
  .word-text { font-weight: 500; margin-right: 6px; font-size:18px; display:inline-block; vertical-align:middle; }
  .pronounce-btn { border: none; background: transparent; cursor: pointer; font-size: 18px; vertical-align: middle; margin-left:4px; padding:2px 6px; }
  .pronounce-btn:hover { color: #007BFF; }
</style>
</head>
<body>
<div class="wrap">
  <h1>å•è¯è®°å¿†ç³»ç»Ÿ</h1>
  <div class="tabs" role="tablist">
    <div class="tab active" id="tab-learn" onclick="switchTab('learn')">å­¦ä¹ </div>
    <div class="tab" id="tab-review" onclick="switchTab('review')">å¤ä¹ </div>
    <div class="tab" id="tab-wrong" onclick="switchTab('wrong')">é”™é¢˜æœ¬</div>
    <div class="tab" id="tab-upload" onclick="switchTab('upload')">ä¸Šä¼ è¯åº“</div>
    <div class="tab" id="tab-stats" onclick="switchTab('stats')">ç»Ÿè®¡</div>
  </div>

  <div id="content">
    <div id="pane-learn">
      <div class="stat" id="topStats">
        <div><strong id="totalWords">0</strong><div class="small">æ€»å•è¯</div></div>
        <div><strong id="learnedWords">0</strong><div class="small">å·²å­¦å•è¯</div></div>
        <div><strong id="dueToday">0</strong><div class="small">ä»Šæ—¥å¾…å¤ä¹ </div></div>
      </div>
      <div class="progressBar"><div id="progressInner" class="progressBarInner"></div></div>
      <div id="wordBox">æ­£åœ¨åŠ è½½è¯åº“â€¦â€¦</div>
      <div class="controls" style="margin-top:10px">
        <div class="flex-row">
          <button class="btn" onclick="prevGroup()">ä¸Šä¸€ç»„</button>
          <button class="btn" onclick="nextGroup()">ä¸‹ä¸€ç»„</button>
          <button class="btn" onclick="markGroupLearned()">å®Œæˆå­¦ä¹ ï¼ˆæ ‡è®°æœ¬ç»„ä¸ºå·²å­¦ï¼‰</button>
        </div>
        <div class="flex-row">
          <button class="btn" id="startTestBtn" onclick="startTest()">å¼€å§‹æµ‹è¯•ï¼ˆå½“å‰ç»„ï¼‰</button>
          <button class="btn secondary" onclick="requestNotificationPermission()">å¯ç”¨é€šçŸ¥</button>
        </div>
      </div>
      <div class="muted-2" style="margin-top:8px">
        è¯´æ˜ï¼šæ¯ç»„ 5 ä¸ªå•è¯ã€‚å®Œæˆä¸¤è½®åˆæ ¼æµ‹è¯•æˆ–æ‰‹åŠ¨ç‚¹å‡»â€œå®Œæˆå­¦ä¹ â€éƒ½ä¼šå°†æœ¬ç»„å•è¯æ ‡è®°ä¸ºâ€œå·²å­¦â€å¹¶ç”Ÿæˆå¤ä¹ è®¡åˆ’ã€‚
      </div>
      <div id="testArea"></div>
    </div>

    <div id="pane-review" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>å¤ä¹ ä»»åŠ¡</h3>
        <div>
          <button class="btn" onclick="showDue('today')">ä»Šæ—¥å¤ä¹ </button>
          <button class="btn" onclick="showDue('upcoming')">æ‰€æœ‰æœªå®Œæˆå¤ä¹ </button>
        </div>
      </div>
      <div id="reviewList" style="margin-top:12px">æ­£åœ¨åŠ è½½å¤ä¹ ä»»åŠ¡â€¦â€¦</div>
      <div style="margin-top:12px;">
        <button class="btn" onclick="sendTodayNotifications()">æ¨é€ä»Šæ—¥å¤ä¹ é€šçŸ¥</button>
      </div>
    </div>

    <div id="pane-wrong" style="display:none">
      <h3>é”™é¢˜æœ¬</h3>
      <div id="wrongList">æ­£åœ¨åŠ è½½é”™é¢˜æœ¬â€¦â€¦</div>
      <div style="margin-top:8px" class="muted-2">è¯´æ˜ï¼šé”™é¢˜éœ€è¦è¿ç»­ 21 æ¬¡ç­”å¯¹æ‰ä¼šè‡ªåŠ¨ç§»å‡ºï¼›ä»»ä½•ä¸€æ¬¡é”™è¯¯ä¼šä½¿è¯¥è¯è¿ç»­æ­£ç¡®è®¡æ•°é‡ç½®ä¸º 0ã€‚</div>
    </div>

    <div id="pane-upload" style="display:none">
      <h3>ä¸Šä¼ è¯åº“ï¼ˆCSVï¼‰</h3>
      <div class="center" style="margin-bottom:8px">
        <input type="file" id="csvFile" accept=".csv" />
        <button class="btn" onclick="uploadCSV()">ä¸Šä¼ å¹¶å¯¼å…¥</button>
      </div>
      <div class="note">
        <strong>æ ¼å¼è¦æ±‚ï¼š</strong> CSV ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜ï¼Œå¿…é¡»åŒ…å« <code>English</code> å’Œ <code>Chinese</code> ä¸¤åˆ—ã€‚
      </div>
    </div>

    <div id="pane-stats" style="display:none">
      <h3>ç»Ÿè®¡æŠ¥å‘Š</h3>
      <div id="statReport">åŠ è½½ä¸­â€¦â€¦</div>
    </div>
  </div>
</div>

<script>
// ======== å‘éŸ³åŠŸèƒ½ ========
async function playPronunciation(word) {
  if (!word || !word.english) return;
  try {
    const resp = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + encodeURIComponent(word.english.toLowerCase()));
    if (!resp.ok) throw new Error('No audio');
    const data = await resp.json();
    const audioUrl = data[0]?.phonetics?.find(p=>p.audio)?.audio;
    if (!audioUrl) throw new Error('No audio field');
    const audio = new Audio(audioUrl);
    audio.play().catch(err => console.warn('Audio play failed', err));
  } catch (e) {
    console.warn('Pronunciation fetch failed', e);
    alert('æ— æ³•è·å–å‘éŸ³ï¼ˆè¯å…¸æ— å¯¹åº”éŸ³é¢‘æˆ–ç½‘ç»œé—®é¢˜ï¼‰');
  }
}

// ======== åŸæœ‰å˜é‡ä¸é…ç½® ========
const REVIEW_DAYS = [1,2,3,5,7,9,12,14,17,21], GROUP_SIZE = 5;
let allWords = [], groupIdx = 0, currentTab = 'learn', testState = null;
const KEY_STATE = 'vocab_full_state_v2', KEY_WRONGBK = 'vocab_wrongbook_v2', KEY_DAILY = 'vocab_daily_stats_v2';
let wrongBook = {}, dailyStats = {};

// å·¥å…·å‡½æ•°
function formatDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function addDays(base,n){ const d=new Date(base); d.setDate(d.getDate()+n); return d; }
function esc(s){ if(!s) return ''; return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function stripQuotes(s){ if(typeof s!=='string') return s; s=s.trim(); if((s.startsWith('"')&&s.endsWith('"'))||(s.startsWith("'")&&s.endsWith("'"))) s=s.slice(1,-1); return s.trim(); }
function parseCSV(text){ if(!text) return []; if(text.charCodeAt(0)===0xFEFF) text=text.slice(1); const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0); if(lines.length===0) return []; const rows=[]; for(let line of lines){ const idx=line.indexOf(','); if(idx===-1) rows.push([stripQuotes(line),'']); else rows.push([stripQuotes(line.slice(0,idx)), stripQuotes(line.slice(idx+1))]); } const header=(rows[0]||[]).map(c=>c.toLowerCase()); if(header.includes('english')&&header.includes('chinese')) rows.shift(); return rows.map(r=>[r[0]||'', r[1]||'']).filter(r=>r[0]); }
function saveAllState(){ localStorage.setItem(KEY_STATE, JSON.stringify(allWords)); localStorage.setItem(KEY_WRONGBK, JSON.stringify(wrongBook)); localStorage.setItem(KEY_DAILY, JSON.stringify(dailyStats)); }
function loadAllState(){ allWords=JSON.parse(localStorage.getItem(KEY_STATE)||'[]'); wrongBook=JSON.parse(localStorage.getItem(KEY_WRONGBK)||'{}'); dailyStats=JSON.parse(localStorage.getItem(KEY_DAILY)||'{}'); }

// ======== åˆå§‹åŒ– ========
async function loadInitial(){
  loadAllState();
  if(allWords.length>0){ renderAll(); return; }
  // è‹¥æ²¡æœ‰æ•°æ®ï¼Œå¯ä»¥è¦æ±‚ç”¨æˆ·ä¸Šä¼  CSV
  document.getElementById('wordBox').innerHTML = '<div class="muted">è¯·ä¸Šä¼  CSV è¯åº“ (English,Chinese)</div>';
  renderAll();
}

// ======== æ¸²æŸ“å­¦ä¹ é¡µ ========
function renderLearn(){
  const box = document.getElementById('wordBox');
  if(!allWords.length){ box.innerHTML = '<div class="muted">è¯åº“ä¸ºç©ºï¼Œè¯·ä¸Šä¼  CSVã€‚</div>'; updateStats(); updateProgressBar(); return; }
  const start = groupIdx * GROUP_SIZE;
  const group = allWords.slice(start, start + GROUP_SIZE);
  if(!group.length){ box.innerHTML = '<div class="muted">å·²åˆ°æœ«å°¾ï¼Œæ²¡æœ‰æ›´å¤šç»„ã€‚</div>'; updateStats(); updateProgressBar(); return; }
  let html = `<div class="small">ç« èŠ‚: ç¬¬ ${group[0].chapterIdx+1} ç«  Â· å…³å¡: ç¬¬ ${group[0].levelIdx+1} å…³ Â· ç»„: ç¬¬ ${group[0].groupIdx+1}</div>`;
  group.forEach(w=>{
    html += `<div class="wordItem">
      <span class="word-text">${esc(w.english)}</span>
      <button class="pronounce-btn" onclick="playPronunciation({english:'${esc(w.english)}'})">ğŸ”Š</button><br>
      <span class="small">${esc(w.phonetic||'')}</span><br>
      <span class="muted">${esc(w.chinese)}</span><div class="small" style="margin-top:6px">çŠ¶æ€: ${w.learned?'<span class="badge ok">å·²å­¦</span>':'<span class="badge">æœªå­¦</span>'}</div>
    </div>`;
  });
  box.innerHTML = html;
  updateStats();
  updateProgressBar();
}

// ======== æ›´æ–°è¿›åº¦ & ç»Ÿè®¡ ========
function updateStats(){ document.getElementById('totalWords').innerText = allWords.length; document.getElementById('learnedWords').innerText = allWords.filter(w=>w.learned).length; const today=formatDate(new Date()); const due = allWords.filter(w=>w.reviewDates && w.reviewDates.includes(today) && !(w.reviewDone||[]).includes(today)).length; document.getElementById('dueToday').innerText = due; }
function updateProgressBar(){ const total=allWords.length; const learned=allWords.filter(w=>w.learned).length; document.getElementById('progressInner').style.width = total?Math.round(learned/total*100)+'%':'0%'; }

// ======== åˆ†ç»„å¯¼èˆªä¸æ ‡è®°å·²å­¦ ========
function prevGroup(){ if(groupIdx>0) groupIdx--; renderLearn(); }
function nextGroup(){ if((groupIdx+1)*GROUP_SIZE < allWords.length) groupIdx++; renderLearn(); }
function markGroupLearned(){
  const start = groupIdx * GROUP_SIZE; const group = allWords.slice(start, start + GROUP_SIZE);
  const today=formatDate(new Date());
  group.forEach(w=>{ if(!w.learned){ w.learned=true; w.learnedDate=today; w.reviewDates = REVIEW_DAYS.map(d=>formatDate(addDays(new Date(),d))); w.reviewDone=[];} });
  saveAllState(); renderLearn();
}

// ======== æµ‹è¯•é€»è¾‘ï¼ˆå››é€‰ä¸€ï¼‰ ========
function startTest(){
  const start = groupIdx * GROUP_SIZE;
  const group = allWords.slice(start, start + GROUP_SIZE);
  if(!group.length) return alert('æœ¬ç»„æ²¡æœ‰å•è¯');
  const pool = allWords.map(w=>w.chinese).filter(Boolean);
  const questions = group.map(w=>{
    const distract=[]; let attempts=0;
    while(distract.length<3 && attempts<300){
      const pick = pool[Math.floor(Math.random()*pool.length)];
      if(pick && pick!==w.chinese && !distract.includes(pick)) distract.push(pick);
      attempts++;
    }
    const opts = [...distract, w.chinese].sort(()=>Math.random()-0.5);
    return { wordObj:w, options:opts, answer:w.chinese };
  });
  testState = { questions, qIndex:0, round:(group[0].testsPassed||0)+1, correctCount:0, wrongList:[], isRetest:false };
  renderQuestion();
}

function renderQuestion(){
  if(!testState) return;
  const area = document.getElementById('testArea');
  if(testState.qIndex >= testState.questions.length){
    const correct = testState.correctCount, total = testState.questions.length;
    const pass = correct/total >= 0.6;
    const start = groupIdx * GROUP_SIZE; const group = allWords.slice(start, start + GROUP_SIZE);
    group.forEach(w=>{ if(pass) w.testsPassed=(w.testsPassed||0)+1; });
    if(group.every(w=>(w.testsPassed||0)>=2)){
      const today=formatDate(new Date());
      group.forEach(w=>{ if(!w.learned){ w.learned=true; w.learnedDate=today; w.reviewDates = REVIEW_DAYS.map(d=>formatDate(addDays(new Date(),d))); w.reviewDone=[]; dailyStats[today]=(dailyStats[today]||{learned:0}); dailyStats[today].learned++; } });
    }
    (testState.wrongList||[]).forEach(w=>{ if(!wrongBook[w.id]) wrongBook[w.id]={id:w.id,english:w.english,chinese:w.chinese,consecutiveCorrect:0}; });
    saveAllState();
    const msg = `æœ¬è½®ç»“æŸï¼šæ­£ç¡® ${correct}/${total}ã€‚${pass?'é€šè¿‡':'æœªé€šè¿‡'}` + (group.every(w=>(w.testsPassed||0)>=2)?' å…¨ç»„å·²é€šè¿‡æµ‹è¯•å¹¶ç”Ÿæˆå¤ä¹ è®¡åˆ’ã€‚':'');
    if((testState.wrongList||[]).length>0){
      if(confirm(msg + `\n\nä½ æœ‰ ${(testState.wrongList||[]).length} é“é”™é¢˜ï¼Œæ˜¯å¦ç«‹å³å¤æµ‹ï¼Ÿ`)){
        testState = { questions:(testState.wrongList||[]).map(w=>({ wordObj:w, options:makeOptionsFor(w), answer:w.chinese })), qIndex:0, round:1, correctCount:0, wrongList:[], isRetest:true };
        renderQuestion(); return;
      } else {
        alert(msg + '\né”™é¢˜å·²åŠ å…¥é”™é¢˜æœ¬ï¼Œå¯ç¨åå¤ä¹ ã€‚');
      }
    } else {
      alert(msg);
    }
    testState=null; area.innerHTML=''; renderAll(); return;
  }
  const q = testState.questions[testState.qIndex];
  let html = `<div class="testArea"><div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>ç¬¬ ${testState.qIndex+1}/${testState.questions.length}</strong> Â· ç¬¬ ${testState.round} è½®</div>
    <div><button class="btn" onclick="endTestEarly()">ç»“æŸæµ‹è¯•</button></div></div><hr>
    <div style="font-size:18px;margin-bottom:8px"><span class="word-text">${esc(q.wordObj.english)}</span><button class="pronounce-btn" onclick="playPronunciation({english:'${esc(q.wordObj.english)}'})">ğŸ”Š</button> <span class="muted">${esc(q.wordObj.phonetic||'')}</span></div><div id="choicesArea">`;
  q.options.forEach(opt=> html += `<div class="choice" data-answer="${escapeAttr(q.answer)}">${esc(opt)}</div>`);
  html += `</div></div>`;
  area.innerHTML = html;
  document.querySelectorAll('#choicesArea .choice').forEach(ch=>ch.addEventListener('click', ()=> handleChoiceClick(ch,q)));
}

function escapeAttr(s){ if(!s) return ''; return (''+s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,"&#39;").replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function handleChoiceClick(el,q){
  if(!testState) return;
  const correctAnswer = el.getAttribute('data-answer') || '';
  const user = el.innerText.trim();
  const choices = el.parentElement.querySelectorAll('.choice');
  choices.forEach(ch=>{ ch.style.pointerEvents='none'; ch.classList.remove('correct','wrong'); if(ch.getAttribute('data-answer')===correctAnswer) ch.classList.add('correct'); if(ch===el && user!==correctAnswer) ch.classList.add('wrong'); });
  if(user === correctAnswer){
    testState.correctCount++;
    if(testState.isRetest){
      const id=q.wordObj.id;
      wrongBook[id]=wrongBook[id]||{id,english:q.wordObj.english,chinese:q.wordObj.chinese,consecutiveCorrect:0};
      wrongBook[id].consecutiveCorrect = (wrongBook[id].consecutiveCorrect||0)+1;
      if(wrongBook[id].consecutiveCorrect>=21) delete wrongBook[id];
    }
  } else {
    testState.wrongList = testState.wrongList||[];
    testState.wrongList.push({id:q.wordObj.id, english:q.wordObj.english, chinese:q.wordObj.chinese});
    if(testState.isRetest){
      const id=q.wordObj.id;
      wrongBook[id]=wrongBook[id]||{id,english:q.wordObj.english,chinese:q.wordObj.chinese,consecutiveCorrect:0};
      wrongBook[id].consecutiveCorrect=0;
    }
  }
  testState.qIndex++; setTimeout(renderQuestion, 300);
}

function endTestEarly(){
  if(confirm('ç¡®å®šæå‰ç»“æŸæœ¬è½®æµ‹è¯•ï¼Ÿ')){
    testState=null;
    document.getElementById('testArea').innerHTML='';
    saveAllState();
  }
}

function makeOptionsFor(word){
  const pool = allWords.map(w=>w.chinese).filter(Boolean);
  const others = [];
  let attempts=0;
  while(others.length<3 && attempts<300){
    const pick = pool[Math.floor(Math.random()*pool.length)];
    if(pick && pick!==word.chinese && !others.includes(pick)) others.push(pick);
    attempts++;
  }
  return [...others, word.chinese].sort(()=>Math.random()-0.5);
}

// ======== å¤ä¹  / é€šçŸ¥ / é”™é¢˜æœ¬ / ä¸Šä¼  / ç»Ÿè®¡ ========
function getDueList(filter='today'){
  const today = formatDate(new Date());
  const res=[];
  allWords.forEach(w=>{
    if(!w.learned || !w.reviewDates) return;
    w.reviewDates.forEach(d=>{
      const done = (w.reviewDone||[]).includes(d);
      if(filter==='today' && d===today && !done) res.push({word:w,date:d});
      if(filter==='upcoming' && !done) res.push({word:w,date:d});
    });
  });
  res.sort((a,b)=>a.date.localeCompare(b.date));
  return res;
}

function showDue(which='today'){
  const list = getDueList(which);
  const container = document.getElementById('reviewList');
  if(!list.length){ container.innerHTML='<div class="muted">æš‚æ— å¤ä¹ ä»»åŠ¡</div>'; return; }
  let html='';
  list.forEach(item=>{
    html += `<div class="wordItem"><span class="word-text">${esc(item.word.english)}</span><button class="pronounce-btn" onclick="playPronunciation({english:'${esc(item.word.english)}'})">ğŸ”Š</button> â€” ${esc(item.word.chinese)} <button class="btn" onclick="markReviewed('${item.word.id}','${item.date}')">æ ‡è®°å·²å¤ä¹ </button></div>`;
  });
  container.innerHTML = html;
}

function markReviewed(wordId,date){
  const w = allWords.find(x=>x.id===wordId);
  if(!w) return;
  w.reviewDone = w.reviewDone||[];
  if(!w.reviewDone.includes(date)) w.reviewDone.push(date);
  saveAllState();
  showDue('today');
  updateStats();
}

function requestNotificationPermission(){
  if(!('Notification' in window)) return alert('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥');
  Notification.requestPermission().then(p=>alert('é€šçŸ¥æƒé™: '+p));
}

function sendTodayNotifications(){
  const list = getDueList('today');
  if(!list.length) return alert('ä»Šæ—¥æ— å¤ä¹ ä»»åŠ¡');
  if(Notification.permission!=='granted'){ requestNotificationPermission(); return; }
  const body = list.slice(0,5).map(item=>item.word.english+' â€” '+item.word.chinese).join('\n');
  new Notification('ä»Šæ—¥å¤ä¹ ', { body });
}

function renderWrongBook(){
  const container = document.getElementById('wrongList');
  const keys = Object.keys(wrongBook||{});
  if(!keys.length){ container.innerHTML = '<div class="muted">é”™é¢˜æœ¬ä¸ºç©º</div>'; return; }
  let html = '';
  keys.forEach(k=>{
    const w = wrongBook[k];
    html += `<div class="wordItem"><span class="word-text">${esc(w.english)}</span><button class="pronounce-btn" onclick="playPronunciation({english:'${esc(w.english)}'})">ğŸ”Š</button> â€” ${esc(w.chinese)} ï¼ˆè¿ç»­æ­£ç¡®: ${w.consecutiveCorrect||0}ï¼‰ <button class="btn" onclick="retestWrong('${w.id}')">å¤æµ‹</button> <button class="btn danger" onclick="removeWrongManual('${w.id}')">ç§»é™¤</button></div>`;
  });
  container.innerHTML = html;
}

function retestWrong(wordId){
  const w = wrongBook[wordId];
  if(!w) return alert('é”™é¢˜ä¸å­˜åœ¨');
  testState = { questions:[{ wordObj:{ id:w.id, english:w.english, chinese:w.chinese }, options:makeOptionsFor(w), answer:w.chinese }], qIndex:0, round:1, correctCount:0, wrongList:[], isRetest:true };
  renderQuestion();
}

function removeWrongManual(wordId){
  if(confirm('ç¡®è®¤ç§»é™¤è¯¥é”™é¢˜ï¼Ÿ')){
    delete wrongBook[wordId];
    saveAllState();
    renderWrongBook();
  }
}

function uploadCSV(){
  const f = document.getElementById('csvFile').files[0];
  if(!f) return alert('è¯·é€‰æ‹© CSV');
  const reader = new FileReader();
  reader.onload = e=>{
    const rows = parseCSV(e.target.result);
    if(!rows.length) return alert('CSV å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸å¯¹');
    if(!confirm('å¯¼å…¥æ–°è¯åº“å°†æ¸…ç©ºå½“å‰è¿›åº¦ä¸é”™é¢˜æœ¬ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
    allWords = rows.map((r,i)=>{
      const g = Math.floor(i/GROUP_SIZE), level = Math.floor(g/3), chapter = Math.floor(level/3);
      return { id:'w'+i, english:r[0], phonetic:'', chinese:r[1]||'', groupIdx:g, levelIdx:level, chapterIdx:chapter, learned:false, learnedDate:null, reviewDates:[], reviewDone:[], testsPassed:0 };
    });
    wrongBook = {}; dailyStats = {}; groupIdx = 0;
    saveAllState(); renderAll(); alert('å¯¼å…¥æˆåŠŸ');
  };
  reader.readAsText(f,'utf-8');
}

function renderStatsReport(){
  const container = document.getElementById('statReport');
  if(!allWords.length){ container.innerHTML = '<div class="muted">è¯åº“ä¸ºç©º</div>'; return; }
  const total = allWords.length, learned = allWords.filter(w=>w.learned).length;
  const dueToday = getDueList('today').length;
  let html = `<div>æ€»è¯æ•°: ${total} Â· å·²å­¦: ${learned} Â· ä»Šæ—¥å¾…å¤ä¹ : ${dueToday}</div>`;
  html += `<h4>æ¯æ—¥å­¦ä¹ ç»Ÿè®¡</h4>`;
  const dates = Object.keys(dailyStats).sort().reverse();
  if(!dates.length) html += '<div class="muted">æš‚æ— å­¦ä¹ è®°å½•</div>';
  else {
    html += '<table><tr><th>æ—¥æœŸ</th><th>å­¦è¯æ•°</th></tr>';
    dates.forEach(d => html += `<tr><td>${d}</td><td>${dailyStats[d].learned||0}</td></tr>`);
    html += '</table>';
  }
  html += `<h4>é”™é¢˜æœ¬ç»Ÿè®¡</h4><div>é”™é¢˜æ€»æ•°: ${Object.keys(wrongBook).length}ï¼ˆéœ€è¿ç»­ 21 æ¬¡æ­£ç¡®ç§»é™¤ï¼‰</div>`;
  container.innerHTML = html;
}

function switchTab(tab){
  currentTab = tab;
  ['learn','review','wrong','upload','stats'].forEach(t=>{
    const pane = document.getElementById('pane-'+t);
    const tabEl = document.getElementById('tab-'+t);
    if(pane) pane.style.display = (t===tab?'block':'none');
    if(tabEl) tabEl.classList.toggle('active', t===tab);
  });
  if(tab==='review') showDue('today');
  if(tab==='wrong') renderWrongBook();
  if(tab==='stats') renderStatsReport();
}

function renderAll(){
  renderLearn();
  updateStats();
  updateProgressBar();
  if(currentTab==='review') showDue('today');
  if(currentTab==='wrong') renderWrongBook();
  if(currentTab==='stats') renderStatsReport();
}

window.addEventListener('load', loadInitial);
</script>
</body>
</html>
