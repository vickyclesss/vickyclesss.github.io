<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>单词记忆系统（CSV: English,Chinese）</title>
<style>
  body { background:#f3f7fa; font-family: "Segoe UI", Tahoma, Arial; color:#222; margin:0; padding:20px; }
  .wrap{max-width:980px;margin:24px auto;background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
  h1{text-align:center;margin:8px 0 18px}
  .tabs{display:flex;gap:12px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:8px 14px;border-radius:8px;cursor:pointer;background:#eef6ff;color:#007bff}
  .tab.active{background:#007bff;color:#fff}
  #wordBox{min-height:160px;padding:16px;border-radius:8px;background:#fafafa;border:1px solid #eee;margin-bottom:12px}
  .wordItem{padding:10px;border-bottom:1px dashed #eee}
  .controls{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .btn{background:#007bff;color:#fff;padding:8px 14px;border:none;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#6c757d}
  .small{font-size:13px;color:#666}
  .stat{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin:12px 0}
  .stat>div{background:#f6fbff;padding:10px;border-radius:8px;border:1px solid #e6f0ff;min-width:120px;text-align:center}
  .uploader{padding:8px;background:#fff;border-radius:8px;border:1px dashed #ddd;display:inline-block}
  .testArea{padding:12px;background:#fff;border-radius:8px;border:1px solid #eee;margin-top:12px}
  .choice{display:block;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #eee;cursor:pointer;background:#fff}
  .choice.correct{background:#e6ffea;border-color:#8fdd9c}
  .choice.wrong{background:#ffecec;border-color:#ff9a9a}
  .progressBar{height:10px;background:#e9f4ff;border-radius:999px;overflow:hidden;margin:12px 0}
  .progressBarInner{height:100%;background:#007bff;width:0%}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee}
  .muted{color:#888;font-size:13px}
  .center{display:flex;justify-content:center;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>单词记忆系统（CSV 标题：English,Chinese）</h1>

  <div class="tabs">
    <div class="tab active" id="tab-learn" onclick="switchTab('learn')">学习</div>
    <div class="tab" id="tab-review" onclick="switchTab('review')">复习</div>
    <div class="tab" id="tab-upload" onclick="switchTab('upload')">上传词库</div>
    <div class="tab" id="tab-stats" onclick="switchTab('stats')">统计</div>
  </div>

  <div id="content">
    <!-- 学习 -->
    <div id="pane-learn">
      <div class="stat" id="topStats">
        <div><strong id="totalWords">0</strong><div class="small">总单词</div></div>
        <div><strong id="learnedWords">0</strong><div class="small">已学单词</div></div>
        <div><strong id="dueToday">0</strong><div class="small">今日待复习</div></div>
      </div>

      <div class="progressBar"><div id="progressInner" class="progressBarInner"></div></div>

      <div id="wordBox">正在加载词库……</div>

      <div class="controls" style="margin-top:12px">
        <div>
          <button class="btn" onclick="prevGroup()">上一组</button>
          <button class="btn" onclick="nextGroup()">下一组</button>
        </div>
        <div>
          <button class="btn" id="startTestBtn" onclick="startTest()">开始测试（当前组）</button>
          <button class="btn secondary" onclick="requestNotificationPermission()">启用通知</button>
        </div>
      </div>

      <div class="small" style="margin-top:8px">说明：每组 5 个单词，需要通过 <strong>两轮测试</strong>（每轮随机出题）才算该组学完并生成复习计划（复习天：1,2,3,5,7,9,12,14,17,21）。</div>

      <div id="testArea"></div>
    </div>

    <!-- 复习 -->
    <div id="pane-review" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>复习任务</h3>
        <div>
          <button class="btn" onclick="showDue('today')">今日复习</button>
          <button class="btn" onclick="showDue('upcoming')">所有未完成复习</button>
        </div>
      </div>
      <div id="reviewList" style="margin-top:12px">正在加载复习任务……</div>
      <div style="margin-top:12px;">
        <button class="btn" onclick="sendTodayNotifications()">推送今日复习通知</button>
      </div>
    </div>

    <!-- 上传 -->
    <div id="pane-upload" style="display:none">
      <h3>上传词库（CSV）</h3>
      <div class="uploader center">
        <input type="file" id="csvFile" accept=".csv" />
        <button class="btn" onclick="uploadCSV()">上传并导入</button>
      </div>
      <div style="margin-top:12px">
        <p class="muted">CSV 格式说明：第一行为标题，必须为 <code>English,Chinese</code>（不区分大小写）。每行示例：<code>apple,苹果</code></p>
        <p class="muted">上传新词库会重置当前进度（若需保留，请先导出备份）。</p>
      </div>
    </div>

    <!-- 统计 -->
    <div id="pane-stats" style="display:none">
      <h3>统计报告</h3>
      <div id="statReport">加载中……</div>
    </div>
  </div>
</div>

<script>
/* ================= 配置 ================= */
const REVIEW_DAYS = [1,2,3,5,7,9,12,14,17,21];
const GROUP_SIZE = 5; // 每页/组 5 个
let allWords = [];   // 单词数据结构数组
let groupIdx = 0;
let currentTab = 'learn';
let testState = null;

/* ======= 日期工具 ======= */
function formatDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function addDays(baseDate, n){ const d=new Date(baseDate); d.setDate(d.getDate()+n); return d; }

/* ======= 本地存储 ======= */
const STORAGE_KEY = 'vocab_system_csv_v1';
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({allWords})); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return false; try{ const obj = JSON.parse(raw); allWords = obj.allWords || []; return true; } catch(e){ console.error(e); return false; } }

/* ======= CSV 解析 (有标题 English,Chinese) ======= */
function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  if(lines.length===0) return [];
  // 解析每行，用第一个逗号分割（避免简单场景中多余逗号）
  const rows = lines.map(line => {
    // 尝试更稳妥的分割：把第一列到第一个逗号，剩下为第二列
    const idx = line.indexOf(',');
    if(idx === -1) return [line.trim(), ''];
    const a = line.slice(0, idx).trim();
    const b = line.slice(idx+1).trim();
    return [a,b];
  });
  // 判断并移除标题行（检查第一行是否包含 english 或 chinese）
  const header = rows[0].map(c=> (c||'').toString().toLowerCase() );
  if(header.includes('english') && header.includes('chinese')) rows.shift();
  // 返回规范二维数组 [english, chinese]
  return rows.map(r => [r[0]||'', r[1]||'']).filter(r => r[0]);
}

/* ======= 初始化单词数组并分组/关/章 ======= */
function initializeWords(rows){
  allWords = rows.map((r,i) => {
    const groupIndex = Math.floor(i / GROUP_SIZE);
    const levelIndex = Math.floor(groupIndex / 3);      // 3 组 = 1 关
    const chapterIndex = Math.floor(levelIndex / 3);    // 3 关 = 1 章
    return {
      id: 'w'+i,
      english: r[0],
      phonetic: '',           // CSV 无音标，留空
      chinese: r[1],
      groupIdx: groupIndex,
      levelIdx: levelIndex,
      chapterIdx: chapterIndex,
      learned: false,
      learnedDate: null,
      reviewDates: [],
      reviewDone: [],
      testsPassed: 0
    };
  });
}

/* ======= 加载初始词库：优先 localStorage，否则尝试根目录 sample-vocabulary.csv ======= */
async function loadInitial(){
  if(loadState() && allWords.length>0){ renderAll(); return; }
  try{
    const res = await fetch('sample-vocabulary.csv');
    if(!res.ok) throw new Error('no csv');
    const txt = await res.text();
    const rows = parseCSV(txt);
    initializeWords(rows);
    saveState();
    renderAll();
  } catch(e){
    document.getElementById('wordBox').innerHTML = '<div class="muted">未找到 sample-vocabulary.csv，请上传 CSV 文件（标题须为 English,Chinese）进行导入。</div>';
    updateStats();
  }
}

/* ======= 渲染学习页 ======= */
function renderLearn(){
  const box = document.getElementById('wordBox');
  if(allWords.length === 0){
    box.innerHTML = '<div class="muted">词库为空，请上传 CSV。</div>';
    updateStats();
    updateProgressBar();
    return;
  }
  const start = groupIdx * GROUP_SIZE;
  const group = allWords.slice(start, start + GROUP_SIZE);
  if(group.length === 0){
    box.innerHTML = '<div class="muted">已到末尾，没有更多组。</div>';
    updateStats();
    updateProgressBar();
    return;
  }
  let html = `<div class="small">章节: 第 ${group[0].chapterIdx+1} 章 · 关卡: 第 ${group[0].levelIdx+1} 关 · 组: 第 ${group[0].groupIdx+1}</div>`;
  group.forEach(w => {
    html += `<div class="wordItem">
      <strong style="font-size:18px">${escapeHtml(w.english)}</strong> <span class="small" style="margin-left:8px">${escapeHtml(w.phonetic||'')}</span><br>
      <span class="muted">${escapeHtml(w.chinese)}</span>
      <div class="small" style="margin-top:6px">状态: ${w.learned?('已学 ('+w.testsPassed+' 轮)'):'未学'}</div>
    </div>`;
  });
  box.innerHTML = html;
  updateStats();
  updateProgressBar();
}

/* ======= updateProgressBar: 必需函数（修复缺失错误） ======= */
function updateProgressBar(){
  const total = allWords.length;
  const learned = allWords.filter(w => w.learned).length;
  const percent = total === 0 ? 0 : Math.round(learned / total * 100);
  const el = document.getElementById('progressInner');
  if(el) el.style.width = percent + '%';
}

/* HTML 转义简单函数 */
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ======= 分页控制 ======= */
function prevGroup(){ if(groupIdx > 0) groupIdx--; renderLearn(); }
function nextGroup(){ const maxG = Math.ceil(allWords.length / GROUP_SIZE) - 1; if(groupIdx < maxG) groupIdx++; renderLearn(); }

/* ======= 测试（四选一）核心逻辑，避免将答案放入 onclick 字符串 ======= */
function startTest(){
  const start = groupIdx * GROUP_SIZE;
  const group = allWords.slice(start, start + GROUP_SIZE);
  if(group.length === 0) { alert('本组没有单词'); return; }
  // 构造问题：每个单词一题，选项为 4 个中文（包含正确）
  const pool = allWords.map(w => w.chinese).filter(Boolean);
  const questions = group.map(w => {
    const others = [];
    // 取最多 3 个干扰项
    let attempts = 0;
    while(others.length < 3 && attempts < 200){
      const pick = pool[Math.floor(Math.random() * pool.length)];
      if(pick && pick !== w.chinese && !others.includes(pick)) others.push(pick);
      attempts++;
    }
    const opts = [...others, w.chinese].sort(() => Math.random() - 0.5);
    return { wordObj: w, options: opts, answer: w.chinese };
  });
  testState = { questions, qIndex: 0, round: (group[0].testsPassed || 0) + 1, correctCount: 0 };
  renderQuestion();
}

function renderQuestion(){
  if(!testState) return;
  if(testState.qIndex >= testState.questions.length){
    // 一轮结束
    const correct = testState.correctCount;
    const total = testState.questions.length;
    const pass = (correct / total) >= 0.6;
    const start = groupIdx * GROUP_SIZE;
    const group = allWords.slice(start, start + GROUP_SIZE);
    group.forEach(w => { if(pass) w.testsPassed = (w.testsPassed || 0) + 1; });
    saveState();
    const reached = group.every(w => (w.testsPassed || 0) >= 2);
    if(reached){
      const today = new Date();
      group.forEach(w => {
        if(!w.learned){
          w.learned = true;
          w.learnedDate = formatDate(today);
          w.reviewDates = REVIEW_DAYS.map(d => formatDate(addDays(today, d)));
          w.reviewDone = [];
        }
      });
      saveState();
    }
    alert(`本轮结束：正确 ${correct}/${total} 。${pass ? '本轮通过。' : '本轮未通过。'}${reached ? ' 本组通过全部轮次，已生成复习计划。' : ''}`);
    testState = null;
    document.getElementById('testArea').innerHTML = '';
    renderLearn();
    return;
  }

  const q = testState.questions[testState.qIndex];
  const area = document.getElementById('testArea');
  let html = `<div class="testArea">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>第 ${testState.qIndex + 1}/${testState.questions.length}</strong> · 第 ${testState.round} 轮</div>
      <div><button class="btn" onclick="endTestEarly()">结束测试</button></div>
    </div><hr>
    <div style="font-size:18px;margin-bottom:8px"><strong>${escapeHtml(q.wordObj.english)}</strong> <span class="muted">${escapeHtml(q.wordObj.phonetic||'')}</span></div>
    <div id="choicesArea">`;
  q.options.forEach(opt => {
    // 使用 data-answer 存正确答案（安全），并将显示文本作为 innerText
    html += `<div class="choice" data-answer="${escapeAttr(q.answer)}">${escapeHtml(opt)}</div>`;
  });
  html += `</div></div>`;
  area.innerHTML = html;

  // 绑定事件监听（确保点击有效）
  const choiceEls = document.querySelectorAll('#choicesArea .choice');
  choiceEls.forEach(ch => {
    ch.addEventListener('click', () => { handleChoiceClick(ch); });
  });
}

function escapeAttr(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,"&#39;").replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function handleChoiceClick(el){
  if(!testState) return;
  const correctAnswer = el.getAttribute('data-answer') || '';
  const user = el.innerText.trim();
  const parent = el.parentElement;
  const choices = parent.querySelectorAll('.choice');
  choices.forEach(ch => {
    // 灰掉后续点击
    ch.style.pointerEvents = 'none';
    const isCorrect = (ch.getAttribute('data-answer') === correctAnswer);
    ch.classList.remove('correct','wrong');
    if(isCorrect) ch.classList.add('correct');
    if(ch === el && ch.innerText.trim() !== correctAnswer) ch.classList.add('wrong');
  });
  if(user === correctAnswer) testState.correctCount++;
  testState.qIndex++;
  setTimeout(() => { renderQuestion(); }, 600);
}

function endTestEarly(){ if(confirm('确定要提前结束本次测试吗？')){ testState = null; document.getElementById('testArea').innerHTML = ''; } }

/* ======= 复习任务逻辑 ======= */
function getDueList(filter = 'today'){
  const today = formatDate(new Date());
  const res = [];
  allWords.forEach(w => {
    if(!w.learned || !w.reviewDates) return;
    w.reviewDates.forEach(d => {
      const done = (w.reviewDone || []).includes(d);
      if(filter === 'today' && d === today && !done) res.push({ word: w, date: d });
      if(filter === 'upcoming' && !done) res.push({ word: w, date: d });
    });
  });
  res.sort((a,b) => a.date.localeCompare(b.date));
  return res;
}

function showDue(which = 'today'){
  const list = getDueList(which);
  const container = document.getElementById('reviewList');
  if(list.length === 0){ container.innerHTML = '<div class="muted">当前没有需要复习的单词。</div>'; return; }
  const groups = {};
  list.forEach(item => { groups[item.date] = groups[item.date] || []; groups[item.date].push(item.word); });
  let html = '';
  for(const date of Object.keys(groups)){
    html += `<h4>${date}（${groups[date].length}）</h4><table><tr><th>单词</th><th>中文</th><th>操作</th></tr>`;
    groups[date].forEach(w => {
      html += `<tr><td>${escapeHtml(w.english)}</td><td>${escapeHtml(w.chinese)}</td>
        <td><button class="btn" onclick="markReviewed('${w.id}','${date}')">标记已复习</button></td></tr>`;
    });
    html += `</table>`;
  }
  container.innerHTML = html;
}

function markReviewed(wordId, date){
  const w = allWords.find(x => x.id === wordId);
  if(!w) return;
  w.reviewDone = w.reviewDone || [];
  if(!w.reviewDone.includes(date)) w.reviewDone.push(date);
  saveState();
  showDue('today');
  updateStats();
}

/* ======= 浏览器通知 ======= */
function requestNotificationPermission(){
  if(!('Notification' in window)) return alert('当前浏览器不支持 Notification API。');
  Notification.requestPermission().then(p => { alert('通知权限：' + p); });
}
function sendTodayNotifications(){
  const list = getDueList('today');
  if(list.length === 0) return alert('今日没有复习任务。');
  if(Notification.permission !== 'granted'){ if(confirm('尚未授权通知，是否现在授权？')) requestNotificationPermission(); return; }
  const title = `今日复习：${list.length} 个单词`;
  const body = list.slice(0,6).map(i => i.word.english + ' — ' + i.word.chinese).join('\n');
  new Notification(title, { body });
  alert('已发送通知（浏览器可能会折叠）。');
}

/* ======= CSV 上传并导入（覆盖并重置进度） ======= */
function uploadCSV(){
  const f = document.getElementById('csvFile').files[0];
  if(!f) return alert('请选择 CSV 文件');
  const reader = new FileReader();
  reader.onload = function(e){
    const rows = parseCSV(e.target.result);
    if(rows.length === 0) return alert('CSV 解析为空或格式错误');
    if(!confirm('上传新词库将会重置当前进度，是否继续？')) return;
    initializeWords(rows);
    saveState();
    groupIdx = 0;
    renderAll();
    alert('导入完成！');
  };
  reader.readAsText(f, 'utf-8');
}

/* ======= 统计 ======= */
function updateStats(){
  const total = allWords.length;
  const learned = allWords.filter(w => w.learned).length;
  const dueToday = getDueList('today').length;
  document.getElementById('totalWords').innerText = total;
  document.getElementById('learnedWords').innerText = learned;
  document.getElementById('dueToday').innerText = dueToday;
}

function renderStatsReport(){
  if(allWords.length === 0){ document.getElementById('statReport').innerHTML = '<div class="muted">词库为空</div>'; return; }
  const total = allWords.length;
  const learned = allWords.filter(w => w.learned).length;
  const dueToday = getDueList('today').length;
  const chapters = {};
  allWords.forEach(w => {
    const ch = w.chapterIdx || 0;
    chapters[ch] = chapters[ch] || { total:0, learned:0 };
    chapters[ch].total++;
    if(w.learned) chapters[ch].learned++;
  });
  let html = `<div class="small">总词数：<strong>${total}</strong> · 已学：<strong>${learned}</strong> · 今日复习：<strong>${dueToday}</strong></div>`;
  html += `<hr><h4>章节进度</h4><table><tr><th>章</th><th>总词</th><th>已学</th><th>进度</th></tr>`;
  Object.keys(chapters).sort((a,b)=>a-b).forEach(ch => {
    const obj = chapters[ch];
    const pct = Math.round(obj.learned / obj.total * 100);
    html += `<tr><td>第 ${parseInt(ch)+1} 章</td><td>${obj.total}</td><td>${obj.learned}</td><td>${pct}%</td></tr>`;
  });
  html += `</table>`;
  document.getElementById('statReport').innerHTML = html;
}

/* ======= 切换标签 ======= */
function switchTab(tab){
  currentTab = tab;
  ['learn','review','upload','stats'].forEach(t => {
    const pane = document.getElementById('pane-' + t);
    const tabEl = document.getElementById('tab-' + t);
    if(pane) pane.style.display = (t === tab ? 'block' : 'none');
    if(tabEl) tabEl.classList.toggle('active', t === tab);
  });
  if(tab === 'review') showDue('today');
  if(tab === 'stats') renderStatsReport();
}

/* ======= 渲染入口 ======= */
function renderAll(){ renderLearn(); updateStats(); updateProgressBar(); if(currentTab === 'review') showDue('today'); if(currentTab === 'stats') renderStatsReport(); }

/* ======= 页面启动 ======= */
window.addEventListener('load', () => {
  loadInitial();
  // 定期刷新统计（防止 localStorage 被更改）
  setInterval(updateStats, 2000);
});
</script>
</body>
</html>
