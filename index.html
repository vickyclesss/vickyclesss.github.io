<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å•è¯è®°å¿†ç³»ç»Ÿ</title>
<style>
  body { background:#f3f7fa; font-family: "Segoe UI", Tahoma, Arial; color:#222; margin:0; padding:18px; }
  .wrap{max-width:980px;margin:18px auto;background:#fff;border-radius:10px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{text-align:center;margin:6px 0 14px}
  .tabs{display:flex;gap:10px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:#eef6ff;color:#007bff;user-select:none}
  .tab.active{background:#007bff;color:#fff}
  #wordBox{min-height:140px;padding:14px;border-radius:8px;background:#fafafa;border:1px solid #eee;margin-bottom:12px}
  .wordItem{padding:10px;border-bottom:1px dashed #eee}
  .controls{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .btn{background:#007bff;color:#fff;padding:8px 14px;border:none;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#6c757d}
  .muted{color:#888;font-size:13px}
  .small{font-size:13px;color:#666}
  .stat{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:10px 0}
  .stat>div{background:#f6fbff;padding:10px;border-radius:8px;border:1px solid #e6f0ff;min-width:120px;text-align:center}
  .testArea{padding:12px;background:#fff;border-radius:8px;border:1px solid #eee;margin-top:12px}
  .choice{display:block;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #eee;cursor:pointer;background:#fff;user-select:none}
  .choice.correct{background:#e6ffea;border-color:#8fdd9c}
  .choice.wrong{background:#ffecec;border-color:#ff9a9a}
  .progressBar{height:10px;background:#e9f4ff;border-radius:999px;overflow:hidden;margin:12px 0}
  .progressBarInner{height:100%;background:#007bff;width:0%}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .center{display:flex;justify-content:center;align-items:center;gap:8px}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;background:#eee;font-size:12px}
  input[type="file"]{display:inline-block}
  .danger{background:#ff6b6b}
  .ok{background:#60c66d}
  .note{background:#fff8dc;padding:10px;border-radius:6px;border:1px solid #ffe6a7}
  .flex-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted-2{color:#9aa0a6;font-size:12px}

  /* æ–°å¢ï¼šå‘éŸ³æŒ‰é’®æ ·å¼ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰ */
  .word-text { font-weight: 500; margin-right: 6px; font-size:18px; display:inline-block; vertical-align:middle; }
  .pronounce-btn { border: none; background: transparent; cursor: pointer; font-size: 18px; vertical-align: middle; margin-left:4px; padding:2px 6px; }
  .pronounce-btn:hover { color: #007BFF; }
</style>
</head>
<body>
<div class="wrap">
  <h1>å•è¯è®°å¿†ç³»ç»Ÿ</h1>

  <div class="tabs" role="tablist">
    <div class="tab active" id="tab-learn" onclick="switchTab('learn')">å­¦ä¹ </div>
    <div class="tab" id="tab-review" onclick="switchTab('review')">å¤ä¹ </div>
    <div class="tab" id="tab-wrong" onclick="switchTab('wrong')">é”™é¢˜æœ¬</div>
    <div class="tab" id="tab-upload" onclick="switchTab('upload')">ä¸Šä¼ è¯åº“</div>
    <div class="tab" id="tab-stats" onclick="switchTab('stats')">ç»Ÿè®¡</div>
  </div>

  <div id="content">
    <!-- å­¦ä¹  Pane -->
    <div id="pane-learn">
      <div class="stat" id="topStats">
        <div><strong id="totalWords">0</strong><div class="small">æ€»å•è¯</div></div>
        <div><strong id="learnedWords">0</strong><div class="small">å·²å­¦å•è¯</div></div>
        <div><strong id="dueToday">0</strong><div class="small">ä»Šæ—¥å¾…å¤ä¹ </div></div>
      </div>

      <div class="progressBar"><div id="progressInner" class="progressBarInner"></div></div>

      <div id="wordBox">æ­£åœ¨åŠ è½½è¯åº“â€¦â€¦</div>

      <div class="controls" style="margin-top:10px">
        <div class="flex-row">
          <button class="btn" onclick="prevGroup()">ä¸Šä¸€ç»„</button>
          <button class="btn" onclick="nextGroup()">ä¸‹ä¸€ç»„</button>
          <button class="btn" onclick="markGroupLearned()">å®Œæˆå­¦ä¹ ï¼ˆæ ‡è®°æœ¬ç»„ä¸ºå·²å­¦ï¼‰</button>
        </div>
        <div class="flex-row">
          <button class="btn" id="startTestBtn" onclick="startTest()">å¼€å§‹æµ‹è¯•ï¼ˆå½“å‰ç»„ï¼‰</button>
          <button class="btn secondary" onclick="requestNotificationPermission()">å¯ç”¨é€šçŸ¥</button>
        </div>
      </div>

      <div class="muted-2" style="margin-top:8px">
        è¯´æ˜ï¼šæ¯ç»„ 5 ä¸ªå•è¯ã€‚å®Œæˆä¸¤è½®åˆæ ¼æµ‹è¯•æˆ–æ‰‹åŠ¨ç‚¹å‡»â€œå®Œæˆå­¦ä¹ â€éƒ½ä¼šå°†æœ¬ç»„å•è¯æ ‡è®°ä¸ºâ€œå·²å­¦â€å¹¶ç”Ÿæˆå¤ä¹ è®¡åˆ’ï¼ˆæŒ‰æ—¥ç»Ÿè®¡ä¼šè®°å½•æ¯æ—¥å­¦è¯æ•°ï¼‰ã€‚
      </div>

      <div id="testArea"></div>
    </div>

    <!-- å¤ä¹  Pane -->
    <div id="pane-review" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>å¤ä¹ ä»»åŠ¡</h3>
        <div>
          <button class="btn" onclick="showDue('today')">ä»Šæ—¥å¤ä¹ </button>
          <button class="btn" onclick="showDue('upcoming')">æ‰€æœ‰æœªå®Œæˆå¤ä¹ </button>
        </div>
      </div>
      <div id="reviewList" style="margin-top:12px">æ­£åœ¨åŠ è½½å¤ä¹ ä»»åŠ¡â€¦â€¦</div>
      <div style="margin-top:12px;">
        <button class="btn" onclick="sendTodayNotifications()">æ¨é€ä»Šæ—¥å¤ä¹ é€šçŸ¥</button>
      </div>
    </div>

    <!-- é”™é¢˜æœ¬ Pane -->
    <div id="pane-wrong" style="display:none">
      <h3>é”™é¢˜æœ¬</h3>
      <div id="wrongList">æ­£åœ¨åŠ è½½é”™é¢˜æœ¬â€¦â€¦</div>
      <div style="margin-top:8px" class="muted-2">è¯´æ˜ï¼šé”™é¢˜éœ€è¦è¿ç»­ 21 æ¬¡ç­”å¯¹æ‰ä¼šè‡ªåŠ¨ç§»å‡ºï¼›ä»»ä½•ä¸€æ¬¡é”™è¯¯ä¼šæŠŠè¯¥è¯çš„è¿ç»­æ­£ç¡®è®¡æ•°é‡ç½®ä¸º 0ã€‚</div>
    </div>

    <!-- ä¸Šä¼  Pane -->
    <div id="pane-upload" style="display:none">
      <h3>ä¸Šä¼ è¯åº“ï¼ˆCSVï¼‰</h3>
      <div class="center" style="margin-bottom:8px">
        <input type="file" id="csvFile" accept=".csv" />
        <button class="btn" onclick="uploadCSV()">ä¸Šä¼ å¹¶å¯¼å…¥</button>
      </div>
      <div class="note">
        <strong>æ ¼å¼è¦æ±‚ï¼š</strong> CSV ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜ï¼Œå¿…é¡»åŒ…å« <code>English</code> å’Œ <code>Chinese</code> ä¸¤åˆ—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ã€‚ä¾‹å¦‚ï¼š<code>English,Chinese</code>
        <div class="muted-2" style="margin-top:6px">è‹¥ä¸Šä¼ æ–°è¯åº“ä¼šé‡ç½®å½“å‰è¿›åº¦ï¼ˆåŒ…å«é”™é¢˜æœ¬ä¸æŒ‰æ—¥ç»Ÿè®¡ï¼‰ã€‚</div>
      </div>
    </div>

    <!-- ç»Ÿè®¡ Pane -->
    <div id="pane-stats" style="display:none">
      <h3>ç»Ÿè®¡æŠ¥å‘Š</h3>
      <div id="statReport">åŠ è½½ä¸­â€¦â€¦</div>
    </div>
  </div>
</div>

<script>
/* ================= é…ç½®ä¸çŠ¶æ€ ================= */
const REVIEW_DAYS = [1,2,3,5,7,9,12,14,17,21];
const GROUP_SIZE = 5;
let allWords = []; // {id,english,phonetic?,chinese,groupIdx,levelIdx,chapterIdx,learned,learnedDate,reviewDates,reviewDone,testsPassed}
let groupIdx = 0;
let currentTab = 'learn';
let testState = null;

/* localStorage keys */
const KEY_STATE = 'vocab_full_state_v2';
const KEY_WRONGBK = 'vocab_wrongbook_v2';
const KEY_DAILY = 'vocab_daily_stats_v2';

let wrongBook = {};  // { id: {id,english,chinese,consecutiveCorrect} }
let dailyStats = {}; // { 'YYYY-MM-DD': { learned: N } }

/* ================= å·¥å…·å‡½æ•° ================= */
function formatDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function addDays(base, n){ const d=new Date(base); d.setDate(d.getDate()+n); return d; }
function saveAllState(){ localStorage.setItem(KEY_STATE, JSON.stringify(allWords)); localStorage.setItem(KEY_WRONGBK, JSON.stringify(wrongBook)); localStorage.setItem(KEY_DAILY, JSON.stringify(dailyStats)); }
function loadAllState(){ const s = localStorage.getItem(KEY_STATE); allWords = s ? JSON.parse(s) : []; wrongBook = JSON.parse(localStorage.getItem(KEY_WRONGBK) || '{}'); dailyStats = JSON.parse(localStorage.getItem(KEY_DAILY) || '{}'); }
function esc(s){ if(!s) return ''; return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ================= æ›´ç¨³å¥ CSV è§£æï¼ˆæ”¯æŒ Excel å¯¼å‡ºå¹¶å»æ‰åŒ…è£¹å¼•å·ï¼‰ ================= */
function stripQuotes(s){ if(typeof s !== 'string') return s; s = s.trim(); if((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) s = s.slice(1, -1); return s.trim(); }
function parseCSV(text){
  if(!text) return [];
  // å» BOM
  if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  if(lines.length === 0) return [];
  const rows = [];
  for(let i=0;i<lines.length;i++){
    let line = lines[i];
    const idx = line.indexOf(',');
    if(idx === -1){
      rows.push([ stripQuotes(line), '' ]);
    } else {
      let a = line.slice(0, idx).trim();
      let b = line.slice(idx+1).trim();
      a = stripQuotes(a);
      b = stripQuotes(b);
      rows.push([a,b]);
    }
  }
  // ç§»é™¤æ ‡é¢˜è¡Œï¼ˆEnglish,Chineseï¼‰
  const header = (rows[0]||[]).map(c => (c||'').toString().toLowerCase());
  if(header.includes('english') && header.includes('chinese')) rows.shift();
  return rows.map(r => [r[0]||'', r[1]||'']).filter(r => r[0]);
}

/* ================= åˆå§‹åŒ–ä¸åˆ†ç»„ ================= */
function initializeWords(rows){
  allWords = rows.map((r,i) => {
    const g = Math.floor(i / GROUP_SIZE);
    const level = Math.floor(g / 3);
    const chapter = Math.floor(level / 3);
    return {
      id: 'w'+i,
      english: r[0],
      phonetic: '',
      chinese: r[1] || '',
      groupIdx: g,
      levelIdx: level,
      chapterIdx: chapter,
      learned: false,
      learnedDate: null,
      reviewDates: [],
      reviewDone: [],
      testsPassed: 0
    };
  });
}

/* ================= åˆå§‹åŠ è½½ï¼ˆä¼˜å…ˆ localStorageï¼Œå¦åˆ™æ ¹ç›®å½• sample-vocabulary.csvï¼‰ ================= */
async function loadInitial(){
  loadAllState();
  if(allWords && allWords.length>0){
    renderAll();
    return;
  }
  try {
    const res = await fetch('sample-vocabulary.csv');
    if(!res.ok) throw new Error('no csv');
    const txt = await res.text();
    const rows = parseCSV(txt);
    initializeWords(rows);
    saveAllState();
    renderAll();
  } catch(e){
    document.getElementById('wordBox').innerHTML = '<div class="muted">æœªæ‰¾åˆ° sample-vocabulary.csvï¼Œæˆ–è¯»å–å¤±è´¥ã€‚è¯·åˆ°â€œä¸Šä¼ è¯åº“â€å¯¼å…¥ CSVï¼ˆæ ‡é¢˜ English,Chineseï¼‰ã€‚</div>';
    renderAll();
  }
}

/* ================= æ¸²æŸ“å­¦ä¹ é¡µ ================= */
function renderLearn(){
  const box = document.getElementById('wordBox');
  if(!allWords || allWords.length === 0){
    box.innerHTML = '<div class="muted">è¯åº“ä¸ºç©ºï¼Œè¯·ä¸Šä¼  CSVã€‚</div>';
    updateStats();
    updateProgressBar();
    return;
  }
  const start = groupIdx * GROUP_SIZE;
  const group = allWords.slice(start, start + GROUP_SIZE);
  if(!group || group.length === 0){
    box.innerHTML = '<div class="muted">å·²åˆ°æœ«å°¾ï¼Œæ²¡æœ‰æ›´å¤šç»„ã€‚</div>';
    updateStats();
    updateProgressBar();
    return;
  }
  let html = `<div class="small">ç« èŠ‚: ç¬¬ ${group[0].chapterIdx+1} ç«  Â· å…³å¡: ç¬¬ ${group[0].levelIdx+1} å…³ Â· ç»„: ç¬¬ ${group[0].groupIdx+1}</div>`;
  group.forEach(w=>{
    html += `<div class="wordItem">
      <strong class="word-text">${esc(w.english)}</strong>
      <span class="small" style="margin-left:8px">${esc(w.phonetic||'')}</span><br>
      <span class="muted">${esc(w.chinese)}</span>
      <div class="small" style="margin-top:6px">çŠ¶æ€: ${w.learned?('<span class="badge ok">å·²å­¦</span>'):'<span class="badge">æœªå­¦</span>'}</div>
    </div>`;
  });
  box.innerHTML = html;

  // --- æ–°å¢ï¼šä¸ºæ¯ä¸ªå•è¯æ’å…¥å‘éŸ³æŒ‰é’®ï¼ˆä½¿ç”¨ Google Translate TTSï¼‰ ---
  try {
    const wordEls = box.querySelectorAll('.word-text');
    wordEls.forEach(el => {
      // å¦‚æœæŒ‰é’®å·²å­˜åœ¨å°±è·³è¿‡ï¼ˆé˜²æ­¢å¤šæ¬¡æ¸²æŸ“é‡å¤æ’å…¥ï¼‰
      if(el.nextSibling && el.nextSibling.classList && el.nextSibling.classList.contains && el.nextSibling.classList.contains('pronounce-btn')) return;
      const btn = document.createElement('button');
      btn.className = 'pronounce-btn';
      btn.type = 'button';
      btn.title = 'æ’­æ”¾å‘éŸ³';
      btn.innerText = 'ğŸ”Š';
      btn.addEventListener('click', () => {
        const word = el.innerText.trim();
        if(!word) return;
        // ä½¿ç”¨ Google Translate TTS ç”Ÿæˆå‘éŸ³
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(word)}&tl=en&client=tw-ob`;
        const audio = new Audio(url);
        audio.play().catch(err => {
          // ä¸è¦é˜»å¡ä¸»æµç¨‹ï¼Œæ§åˆ¶å°è¾“å‡ºé”™è¯¯
          console.error('æ’­æ”¾å¤±è´¥ï¼š', err);
          alert('æ— æ³•æ’­æ”¾å‘éŸ³ï¼ˆæµè§ˆå™¨å¯èƒ½é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾æˆ–è¯¥æ¥å£åœ¨æœ¬åŸŸä¸å¯ç”¨ï¼‰ã€‚');
        });
      });
      // å°†æŒ‰é’®æ’å…¥åˆ°å•è¯åé¢
      el.insertAdjacentElement('afterend', btn);
    });
  } catch(err) {
    console.error('æ’å…¥å‘éŸ³æŒ‰é’®å¤±è´¥ï¼š', err);
  }

  updateStats();
  updateProgressBar();
}

/* ================= è¿›åº¦æ¡ ================= */
function updateProgressBar(){
  const total = allWords.length;
  const learned = allWords.filter(w=>w.learned).length;
  const pct = total===0 ? 0 : Math.round(learned / total * 100);
  const el = document.getElementById('progressInner');
  if(el) el.style.width = pct + '%';
}

/* ================= åˆ†é¡µ ================= */
function prevGroup(){ if(groupIdx>0) groupIdx--; renderLearn(); }
function nextGroup(){ const max = Math.ceil(allWords.length / GROUP_SIZE) - 1; if(groupIdx < max) groupIdx++; renderLearn(); }

/* ================= å®Œæˆå­¦ä¹ ï¼ˆæ‰‹åŠ¨ï¼‰ ================= */
function markGroupLearned(){
  if(!allWords || allWords.length===0) return alert('è¯åº“ä¸ºç©º');
  const start = groupIdx * GROUP_SIZE;
  const group = allWords.slice(start, start + GROUP_SIZE);
  if(group.length===0) return alert('æœ¬ç»„æ²¡æœ‰å•è¯');
  const today = formatDate(new Date());
  let newly = 0;
  group.forEach(w=>{
    if(!w.learned){
      w.learned = true;
      w.learnedDate = today;
      w.reviewDates = REVIEW_DAYS.map(d => formatDate(addDays(new Date(), d)));
      w.reviewDone = [];
      newly++;
    }
  });
  dailyStats[today] = dailyStats[today] || { learned: 0 };
  dailyStats[today].learned = (dailyStats[today].learned || 0) + newly;
  saveAllState();
  alert(`æœ¬ç»„æ ‡è®°ä¸ºå·²å­¦ï¼šå…± ${newly} ä¸ªæ–°å•è¯ï¼ˆå¦‚æœæœ¬ç»„ä¹‹å‰å·²å­¦è¿‡åˆ™ä¸ä¼šé‡å¤è®¡æ•°ï¼‰ã€‚`);
  renderAll();
}

/* ================= æµ‹è¯•ï¼ˆå››é€‰ä¸€ï¼‰ ================= */
function startTest(){
  const start = groupIdx * GROUP_SIZE;
  const group = allWords.slice(start, start + GROUP_SIZE);
  if(!group || group.length===0) return alert('æœ¬ç»„æ²¡æœ‰å•è¯');
  const pool = allWords.map(w=>w.chinese).filter(Boolean);
  const questions = group.map(w => {
    const distract = [];
    let attempts = 0;
    while(distract.length < 3 && attempts < 300){
      const pick = pool[Math.floor(Math.random() * pool.length)];
      if(pick && pick !== w.chinese && !distract.includes(pick)) distract.push(pick);
      attempts++;
    }
    const opts = [...distract, w.chinese].sort(()=>Math.random()-0.5);
    return { wordObj: w, options: opts, answer: w.chinese };
  });
  testState = { questions, qIndex: 0, round: (group[0].testsPassed || 0) + 1, correctCount: 0, wrongList: [], isRetest: false };
  renderQuestion();
}

function renderQuestion(){
  if(!testState) return;
  const area = document.getElementById('testArea');
  if(testState.qIndex >= testState.questions.length){
    // ä¸€è½®ç»“æŸ
    const correct = testState.correctCount;
    const total = testState.questions.length;
    const pass = (correct / total) >= 0.6;
    const start = groupIdx * GROUP_SIZE;
    const group = allWords.slice(start, start + GROUP_SIZE);
    group.forEach(w => { if(pass) w.testsPassed = (w.testsPassed || 0) + 1; });
    const reached = group.every(w => (w.testsPassed || 0) >= 2);
    if(reached){
      const today = formatDate(new Date());
      group.forEach(w => {
        if(!w.learned){
          w.learned = true;
          w.learnedDate = today;
          w.reviewDates = REVIEW_DAYS.map(d => formatDate(addDays(new Date(), d)));
          w.reviewDone = [];
          dailyStats[today] = dailyStats[today] || { learned: 0 };
          dailyStats[today].learned = (dailyStats[today].learned || 0) + 1;
        }
      });
    }
    // é”™é¢˜å¤„ç†ï¼šæŠŠå½“å‰è½®é”™é¢˜åŠ å…¥é”™é¢˜æœ¬
    const wrongs = testState.wrongList || [];
    wrongs.forEach(w => {
      if(!wrongBook[w.id]) wrongBook[w.id] = { id: w.id, english: w.english, chinese: w.chinese, consecutiveCorrect: 0 };
    });
    saveAllState();
    // å¼¹å‡ºç»“æœå¹¶è¯¢é—®æ˜¯å¦å¤æµ‹é”™é¢˜
    const msg = `æœ¬è½®ç»“æŸï¼šæ­£ç¡® ${correct}/${total}ã€‚${pass ? 'æœ¬è½®é€šè¿‡ã€‚' : 'æœ¬è½®æœªé€šè¿‡ã€‚'}${reached ? ' æœ¬ç»„å·²é€šè¿‡å…¨éƒ¨è½®æ¬¡å¹¶ç”Ÿæˆå¤ä¹ è®¡åˆ’ã€‚' : ''}`;
    if(wrongs.length > 0){
      if(confirm(msg + `\n\nä½ æœ‰ ${wrongs.length} é“é”™é¢˜ï¼Œå·²åŠ å…¥é”™é¢˜æœ¬ã€‚æ˜¯å¦ç°åœ¨å¤æµ‹è¿™äº›é”™é¢˜ï¼Ÿï¼ˆé€‰æ‹©â€œå–æ¶ˆâ€å¯ç¨ååœ¨â€œé”™é¢˜æœ¬â€ä¸­å¤ä¹ ï¼‰`)){
        // æ„é€ é”™é¢˜æµ‹è¯•
        testState = { questions: wrongs.map(w => ({ wordObj: w, options: makeOptionsFor(w), answer: w.chinese })), qIndex: 0, round: 1, correctCount: 0, wrongList: [], isRetest: true };
        renderQuestion();
        return;
      } else {
        alert(msg + '\n\né”™é¢˜å·²åŠ å…¥é”™é¢˜æœ¬ï¼Œå¯åœ¨ã€Œé”™é¢˜æœ¬ã€ä¸­å¤ä¹ ã€‚');
      }
    } else {
      alert(msg);
    }
    testState = null;
    area.innerHTML = '';
    saveAllState();
    renderAll();
    return;
  }

  // æ˜¾ç¤ºå½“å‰é¢˜
  const q = testState.questions[testState.qIndex];
  let html = `<div class="testArea"><div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>ç¬¬ ${testState.qIndex + 1}/${testState.questions.length}</strong> Â· ç¬¬ ${testState.round} è½®</div>
    <div><button class="btn" onclick="endTestEarly()">ç»“æŸæµ‹è¯•</button></div>
    </div><hr>
    <div style="font-size:18px;margin-bottom:8px"><strong>${esc(q.wordObj.english)}</strong> <span class="muted">${esc(q.wordObj.phonetic||'')}</span></div>
    <div id="choicesArea">`;
  q.options.forEach(opt => {
    html += `<div class="choice" data-answer="${escapeAttr(q.answer)}">${esc(opt)}</div>`;
  });
  html += `</div></div>`;
  area.innerHTML = html;

  // ç»‘å®šäº‹ä»¶ç›‘å¬
  const choiceEls = document.querySelectorAll('#choicesArea .choice');
  choiceEls.forEach(ch => ch.addEventListener('click', ()=> handleChoiceClick(ch, q)));
}

function escapeAttr(s){ if(!s) return ''; return (''+s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,"&#39;").replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function handleChoiceClick(el, q){
  if(!testState) return;
  const correctAnswer = el.getAttribute('data-answer') || '';
  const user = el.innerText.trim();
  const choices = el.parentElement.querySelectorAll('.choice');
  choices.forEach(ch => { ch.style.pointerEvents = 'none'; ch.classList.remove('correct','wrong'); if(ch.getAttribute('data-answer') === correctAnswer) ch.classList.add('correct'); if(ch === el && ch.innerText.trim() !== correctAnswer) ch.classList.add('wrong'); });
  if(user === correctAnswer){
    testState.correctCount++;
    // é‡æµ‹æ—¶ï¼Œæ›´æ–°é”™é¢˜æœ¬è¿ç»­æ­£ç¡®è®¡æ•°
    if(testState.isRetest){
      const id = q.wordObj.id;
      wrongBook[id] = wrongBook[id] || { id, english: q.wordObj.english, chinese: q.wordObj.chinese, consecutiveCorrect: 0 };
      wrongBook[id].consecutiveCorrect = (wrongBook[id].consecutiveCorrect || 0) + 1;
      if(wrongBook[id].consecutiveCorrect >= 21){
        delete wrongBook[id];
      }
    }
  } else {
    // è®°å½•é”™é¢˜ï¼ˆå½“å‰è½®ï¼‰
    testState.wrongList = testState.wrongList || [];
    testState.wrongList.push({ id: q.wordObj.id, english: q.wordObj.english, chinese: q.wordObj.chinese });
    // è‹¥ä¸ºé‡æµ‹ï¼Œé‡ç½®è¯¥è¯è¿ç»­æ­£ç¡®è®¡æ•°
    if(testState.isRetest){
      const id = q.wordObj.id;
      wrongBook[id] = wrongBook[id] || { id, english: q.wordObj.english, chinese: q.wordObj.chinese, consecutiveCorrect: 0 };
      wrongBook[id].consecutiveCorrect = 0;
    }
  }
  testState.qIndex++;
  setTimeout(()=> renderQuestion(), 700);
}

function endTestEarly(){
  if(confirm('ç¡®å®šè¦æå‰ç»“æŸæœ¬æ¬¡æµ‹è¯•å—ï¼Ÿ æœªå®Œæˆçš„é¢˜ç›®ä¸ä¼šè®¡å…¥æœ¬è½®é€šè¿‡åˆ¤å®š')) {
    testState = null;
    document.getElementById('testArea').innerHTML = '';
    saveAllState();
  }
}

function makeOptionsFor(word){
  const pool = allWords.map(w => w.chinese).filter(Boolean);
  const others = [];
  let attempts = 0;
  while(others.length < 3 && attempts < 300){
    const pick = pool[Math.floor(Math.random()*pool.length)];
    if(pick && pick !== word.chinese && !others.includes(pick)) others.push(pick);
    attempts++;
  }
  const opts = [...others, word.chinese].sort(()=>Math.random()-0.5);
  return opts;
}

/* ================= å¤ä¹ ã€é€šçŸ¥ã€é”™é¢˜æœ¬ UI ================= */
function getDueList(filter='today'){
  const today = formatDate(new Date());
  const res = [];
  allWords.forEach(w=>{
    if(!w.learned || !w.reviewDates) return;
    w.reviewDates.forEach(d=>{
      const done = (w.reviewDone || []).includes(d);
      if(filter==='today' && d===today && !done) res.push({word:w,date:d});
      if(filter==='upcoming' && !done) res.push({word:w,date:d});
    });
  });
  res.sort((a,b)=>a.date.localeCompare(b.date));
  return res;
}

function showDue(which='today'){
  const list = getDueList(which);
  const container = document.getElementById('reviewList');
  if(list.length===0){ container.innerHTML = '<div class="muted">å½“å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚</div>'; return; }
  const groups = {};
  list.forEach(it => { groups[it.date] = groups[it.date] || []; groups[it.date].push(it.word); });
  let html = '';
  for(const date of Object.keys(groups)){
    html += `<h4>${date}ï¼ˆ${groups[date].length}ï¼‰</h4><table><tr><th>å•è¯</th><th>ä¸­æ–‡</th><th>æ“ä½œ</th></tr>`;
    groups[date].forEach(w=>{
      html += `<tr><td>${esc(w.english)}</td><td>${esc(w.chinese)}</td><td><button class="btn" onclick="markReviewed('${w.id}','${date}')">æ ‡è®°å·²å¤ä¹ </button></td></tr>`;
    });
    html += `</table>`;
  }
  container.innerHTML = html;
}

function markReviewed(wordId, date){
  const w = allWords.find(x=>x.id===wordId);
  if(!w) return;
  w.reviewDone = w.reviewDone || [];
  if(!w.reviewDone.includes(date)) w.reviewDone.push(date);
  saveAllState();
  showDue('today');
  updateStats();
}

function requestNotificationPermission(){
  if(!('Notification' in window)) return alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥');
  Notification.requestPermission().then(p => alert('é€šçŸ¥æƒé™ï¼š' + p));
}
function sendTodayNotifications(){
  const list = getDueList('today');
  if(list.length===0) return alert('ä»Šæ—¥æ²¡æœ‰å¤ä¹ ä»»åŠ¡');
  if(Notification.permission !== 'granted'){ if(confirm('å°šæœªæˆæƒé€šçŸ¥ï¼Œæ˜¯å¦ç°åœ¨æˆæƒï¼Ÿ')) requestNotificationPermission(); return; }
  const title = `ä»Šæ—¥å¤ä¹ ï¼š${list.length} ä¸ªå•è¯`;
  const body = list.slice(0,6).map(i=>i.word.english+' â€” '+i.word.chinese).join('\n');
  new Notification(title, { body });
  alert('å·²å‘é€é€šçŸ¥ï¼ˆæµè§ˆå™¨å¯èƒ½ä¼šæŠ˜å ï¼‰ã€‚');
}

/* ================= é”™é¢˜æœ¬æ¸²æŸ“ä¸æ“ä½œ ================= */
function renderWrongBook(){
  const container = document.getElementById('wrongList');
  const keys = Object.keys(wrongBook || {});
  if(keys.length === 0){ container.innerHTML = '<div class="muted">é”™é¢˜æœ¬ä¸ºç©ºã€‚</div>'; return; }
  let html = `<table><tr><th>å•è¯</th><th>ä¸­æ–‡</th><th>è¿ç»­æ­£ç¡®</th><th>æ“ä½œ</th></tr>`;
  keys.forEach(k=>{
    const w = wrongBook[k];
    html += `<tr><td>${esc(w.english)}</td><td>${esc(w.chinese)}</td><td>${w.consecutiveCorrect || 0}</td>
      <td>
        <button class="btn" onclick="retestWrong('${w.id}')">å¤æµ‹</button>
        <button class="btn danger" onclick="removeWrongManual('${w.id}')">æ‰‹åŠ¨ç§»é™¤</button>
      </td></tr>`;
  });
  html += '</table>';
  container.innerHTML = html;
}

function retestWrong(wordId){
  const w = wrongBook[wordId];
  if(!w) return alert('é”™é¢˜ä¸å­˜åœ¨');
  testState = { questions: [{ wordObj: { id: w.id, english: w.english, chinese: w.chinese }, options: makeOptionsFor({ chinese: w.chinese }), answer: w.chinese }], qIndex: 0, round: 1, correctCount: 0, wrongList: [], isRetest: true };
  renderQuestion();
}

function removeWrongManual(wordId){
  if(confirm('ç¡®å®šæ‰‹åŠ¨ç§»é™¤è¯¥é”™é¢˜å—ï¼Ÿ')){
    delete wrongBook[wordId];
    saveAllState();
    renderWrongBook();
  }
}

/* ================= CSV ä¸Šä¼  ================= */
function uploadCSV(){
  const f = document.getElementById('csvFile').files[0];
  if(!f) return alert('è¯·é€‰æ‹© CSV æ–‡ä»¶');
  const reader = new FileReader();
  reader.onload = function(e){
    const rows = parseCSV(e.target.result);
    if(rows.length === 0) return alert('CSV è§£æä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
    if(!confirm('ä¸Šä¼ æ–°è¯åº“å°†ä¼šè¦†ç›–å½“å‰è¯åº“å¹¶é‡ç½®è¿›åº¦ã€é”™é¢˜æœ¬ä¸æŒ‰æ—¥ç»Ÿè®¡ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
    initializeWords(rows);
    wrongBook = {};
    dailyStats = {};
    groupIdx = 0;
    saveAllState();
    renderAll();
    alert('å¯¼å…¥å®Œæˆï¼');
  };
  reader.readAsText(f, 'utf-8');
}

/* ================= ç»Ÿè®¡é¡µæ¸²æŸ“ ================= */
function renderStatsReport(){
  const container = document.getElementById('statReport');
  if(!allWords || allWords.length === 0){
    container.innerHTML = '<div class="muted">è¯åº“ä¸ºç©º</div>'; return;
  }
  const total = allWords.length;
  const learned = allWords.filter(w=>w.learned).length;
  const dueToday = getDueList('today').length;
  let html = `<div class="small">æ€»è¯æ•°ï¼š<strong>${total}</strong> Â· å·²å­¦ï¼š<strong>${learned}</strong> Â· ä»Šæ—¥å¾…å¤ä¹ ï¼š<strong>${dueToday}</strong></div>`;
  html += `<hr><h4>æ¯æ—¥å­¦ä¹ æ•°é‡ï¼ˆæŒ‰æ—¥æœŸï¼‰</h4>`;
  const dates = Object.keys(dailyStats).sort().reverse();
  if(dates.length === 0) html += '<div class="muted">æš‚æ— å­¦ä¹ è®°å½•</div>';
  else {
    html += `<table><tr><th>æ—¥æœŸ</th><th>å­¦è¯æ•°</th></tr>`;
    dates.forEach(d => { html += `<tr><td>${d}</td><td>${dailyStats[d].learned || 0}</td></tr>`; });
    html += `</table>`;
  }
  html += `<hr><h4>é”™é¢˜æœ¬ç»Ÿè®¡</h4>`;
  html += `<div class="small">é”™é¢˜æ€»æ•°ï¼š<strong>${Object.keys(wrongBook).length}</strong>ï¼ˆéœ€è¦è¿ç»­ 21 æ¬¡æ­£ç¡®æ‰ä¼šç§»é™¤ï¼‰</div>`;
  container.innerHTML = html;
}

/* ================= æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º ================= */
function updateStats(){
  const total = allWords.length;
  const learned = allWords.filter(w=>w.learned).length;
  const due = getDueList('today').length;
  document.getElementById('totalWords').innerText = total;
  document.getElementById('learnedWords').innerText = learned;
  document.getElementById('dueToday').innerText = due;
}

/* ================= åˆ‡æ¢ Tab ================= */
function switchTab(tab){
  currentTab = tab;
  ['learn','review','wrong','upload','stats'].forEach(t=>{
    const pane = document.getElementById('pane-'+t);
    const tabEl = document.getElementById('tab-'+t);
    if(pane) pane.style.display = (t===tab ? 'block' : 'none');
    if(tabEl) tabEl.classList.toggle('active', t===tab);
  });
  if(tab === 'review') showDue('today');
  if(tab === 'wrong') renderWrongBook();
  if(tab === 'stats') renderStatsReport();
}

/* ================= æ¸²æŸ“å…¥å£ ================= */
function renderAll(){
  renderLearn();
  updateStats();
  updateProgressBar();
  if(currentTab === 'review') showDue('today');
  if(currentTab === 'wrong') renderWrongBook();
  if(currentTab === 'stats') renderStatsReport();
}

/* ================= é¡µé¢å¯åŠ¨ ================= */
window.addEventListener('load', ()=> {
  loadInitial();
  // å®šæœŸåˆ·æ–°ç»Ÿè®¡/é”™é¢˜æ¸²æŸ“
  setInterval(()=>{ updateStats(); if(currentTab==='wrong') renderWrongBook(); }, 2000);
});
</script>
</body>
</html>
